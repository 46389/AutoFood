{% extends 'food_recognition/base.html' %}

{% block title %}Dashboard - AutoFood{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2><i class="fas fa-chart-bar"></i> Analytics Dashboard</h2>
            <hr>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>{{ total_detections }}</h4>
                            <p class="mb-0">Total Detections</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-search fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>{{ completed_checkouts }}</h4>
                            <p class="mb-0">Completed Checkouts</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-cash-register fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card text-white bg-info">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>RM{{ total_revenue|floatformat:2 }}</h4>
                            <p class="mb-0">Total Revenue</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-dollar-sign fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card text-white bg-warning">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>{% widthratio completed_checkouts total_detections 100 %}%</h4>
                            <p class="mb-0">Completion Rate</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-percentage fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Recent Detections -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-history"></i> Recent Detections</h5>
                </div>
                <div class="card-body">
                    {% if detections %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Items Detected</th>
                                    <th>Status</th>
                                    <th>Total Amount</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for detection in detections %}
                                <tr>
                                    <td>{{ detection.created_at|date:"M d, Y H:i" }}</td>
                                    <td>
                                        <span class="badge bg-secondary">{{ detection.items.count }} items</span>
                                    </td>
                                    <td>
                                        {% if detection.is_checked_out %}
                                            <span class="badge bg-success">Completed</span>
                                        {% else %}
                                            <span class="badge bg-warning">In Progress</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if detection.is_checked_out %}
                                            <strong>RM{{ detection.total_amount|floatformat:2 }}</strong>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{% url 'detection_results' detection.id %}" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye"></i> View
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-search fa-3x mb-3"></i>
                        <h5>No detections yet</h5>
                        <p>Start by going to the home page and processing some images!</p>
                        <a href="{% url 'home' %}" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Start Detection
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Quick Actions & Summary -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-bolt"></i> Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'home' %}" class="btn btn-success">
                            <i class="fas fa-camera"></i> New Detection
                        </a>
                        <a href="{% url 'menu_price' %}" class="btn btn-info">
                            <i class="fas fa-list"></i> Manage Menu
                        </a>
                        <button class="btn btn-outline-secondary" onclick="exportData()">
                            <i class="fas fa-download"></i> Export Data
                        </button>
                    </div>
                </div>
            </div>

            <!-- Today's Summary -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5><i class="fas fa-calendar-day"></i> Today's Summary</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="border-end">
                                <h4 class="text-primary">{{ today_detections|default:0 }}</h4>
                                <small class="text-muted">Detections</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <h4 class="text-success">RM{{ today_revenue|default:0|floatformat:2 }}</h4>
                            <small class="text-muted">Revenue</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Daily Revenue Chart -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5><i class="fas fa-chart-line"></i> Daily Revenue Trend</h5>
                </div>
                <div class="card-body">
                    {% if daily_revenue_data %}
                        <div style="position: relative; height: 300px;">
                            <canvas id="dailyRevenueChart"></canvas>
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i> 
                                Daily revenue from completed orders over the last 14 days
                            </small>
                        </div>
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-chart-line fa-3x mb-3"></i>
                            <h5>No Revenue Data</h5>
                            <p>Daily revenue chart will appear after completing some orders</p>
                            <small>Complete food detections and checkout to see revenue trends</small>
                        </div>
                    {% endif %}
                </div>
            </div>

        </div>
    </div>

    <!-- Popular Items Chart (moved below recent detections) -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-bar"></i> Popular Items</h5>
                </div>
                <div class="card-body">
                    {% if popular_items %}
                        <div style="position: relative; height: 500px;">
                            <canvas id="popularItemsChart"></canvas>
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i> 
                                Showing top food items by number of orders from completed checkouts
                            </small>
                        </div>
                    {% else %}
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-chart-bar fa-3x mb-3"></i>
                            <h5>No Data Available</h5>
                            <p>Popular items chart will appear after completing some orders</p>
                            <small>Complete a few food detections and checkout to see analytics</small>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function exportData() {
    // Redirect to the export endpoint
    window.location.href = '{% url "export_dashboard" %}';
}

// Popular Items Chart
{% if popular_items %}
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('popularItemsChart').getContext('2d');
    
    // Prepare data for Chart.js
    const labels = [{% for item in popular_items %}'{{ item.menu_item__name|escapejs }}'{% if not forloop.last %}, {% endif %}{% endfor %}];
    const orderCounts = [{% for item in popular_items %}{{ item.order_count }}{% if not forloop.last %}, {% endif %}{% endfor %}];
    const revenues = [{% for item in popular_items %}{{ item.total_revenue|floatformat:2 }}{% if not forloop.last %}, {% endif %}{% endfor %}];
    
    // Generate colors for bars
    const backgroundColors = [
        'rgba(138, 166, 36, 0.8)',   // Primary green
        'rgba(254, 164, 5, 0.8)',    // Accent orange
        'rgba(16, 185, 129, 0.8)',   // Success green
        'rgba(59, 130, 246, 0.8)',   // Info blue
        'rgba(239, 68, 68, 0.8)',    // Danger red
        'rgba(168, 85, 247, 0.8)',   // Purple
        'rgba(236, 72, 153, 0.8)',   // Pink
        'rgba(34, 197, 94, 0.8)',    // Emerald
        'rgba(251, 191, 36, 0.8)',   // Yellow
        'rgba(156, 163, 175, 0.8)'   // Gray
    ];
    
    const borderColors = backgroundColors.map(color => color.replace('0.8', '1'));
    
    const chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Number of Orders',
                data: orderCounts,
                backgroundColor: backgroundColors,
                borderColor: borderColors,
                borderWidth: 2,
                borderRadius: 4,
                borderSkipped: false,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Popular Food Items by Number of Orders',
                    font: {
                        size: 16,
                        weight: '600'
                    },
                    padding: 20
                },
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: 'white',
                    bodyColor: 'white',
                    borderColor: 'rgba(138, 166, 36, 1)',
                    borderWidth: 1,
                    callbacks: {
                        afterLabel: function(context) {
                            const index = context.dataIndex;
                            return 'Revenue: RM' + revenues[index];
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of Orders',
                        font: {
                            size: 12,
                            weight: '500'
                        }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Food Items',
                        font: {
                            size: 12,
                            weight: '500'
                        }
                    },
                    grid: {
                        display: false
                    },
                    ticks: {
                        maxRotation: 45,
                        minRotation: 0
                    }
                }
            },
            animation: {
                duration: 1000,
                easing: 'easeOutQuart'
            }
        }
    });
});
{% endif %}

// Daily Revenue Chart
{% if daily_revenue_data %}
document.addEventListener('DOMContentLoaded', function() {
    const ctx2 = document.getElementById('dailyRevenueChart').getContext('2d');
    
    // Prepare data for Daily Revenue Chart
    const dates = [{% for data in daily_revenue_data %}'{{ data.date_display }}'{% if not forloop.last %}, {% endif %}{% endfor %}];
    const revenues = [{% for data in daily_revenue_data %}{{ data.revenue }}{% if not forloop.last %}, {% endif %}{% endfor %}];
    
    // Calculate max revenue for gradient effect
    const maxRevenue = Math.max(...revenues);
    
    // Create gradient
    const gradient = ctx2.createLinearGradient(0, 0, 0, 300);
    gradient.addColorStop(0, 'rgba(138, 166, 36, 0.4)');
    gradient.addColorStop(1, 'rgba(138, 166, 36, 0.1)');
    
    const revenueChart = new Chart(ctx2, {
        type: 'line',
        data: {
            labels: dates,
            datasets: [{
                label: 'Daily Revenue (RM)',
                data: revenues,
                borderColor: 'rgba(138, 166, 36, 1)',
                backgroundColor: gradient,
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: 'rgba(138, 166, 36, 1)',
                pointBorderColor: 'white',
                pointBorderWidth: 2,
                pointRadius: 5,
                pointHoverRadius: 8,
                pointHoverBackgroundColor: 'rgba(254, 164, 5, 1)',
                pointHoverBorderColor: 'white',
                pointHoverBorderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Daily Revenue Trend (Last 14 Days)',
                    font: {
                        size: 16,
                        weight: '600'
                    },
                    padding: 20
                },
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: 'white',
                    bodyColor: 'white',
                    borderColor: 'rgba(138, 166, 36, 1)',
                    borderWidth: 1,
                    callbacks: {
                        label: function(context) {
                            return 'Revenue: RM' + context.parsed.y.toFixed(2);
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Revenue (RM)',
                        font: {
                            size: 12,
                            weight: '500'
                        }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    },
                    ticks: {
                        callback: function(value) {
                            return 'RM' + value.toFixed(0);
                        }
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Date',
                        font: {
                            size: 12,
                            weight: '500'
                        }
                    },
                    grid: {
                        display: false
                    }
                }
            },
            animation: {
                duration: 1500,
                easing: 'easeOutQuart'
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        }
    });
});
{% endif %}

// Auto-refresh dashboard every 30 seconds
setInterval(function() {
    // Could implement real-time updates here
}, 30000);
</script>
{% endblock %}